<main class="hy-tmpl-preshared-key">
  <div class="hy-tmpl-preshared-key-image"></div>
  <div class="hy-tmpl-preshared-key-row">
    <p><i>The pre-shared key is used to authenticate with your Sony BRAVIA Android TV over your local network. You need
        to set it up before you can continue with adding your television. If you need help see the <b>Setting up a
          pre-shared key</b> button below.</i></p>
  </div>
  <form class="hy-tmpl-preshared-key-form">
    <div class="hy-tmpl-preshared-key-row">
      <label class="hy-label" for="preshared_key">Pre-shared key:</p>
    </div>
    <div class="hy-tmpl-preshared-key-row">
      <input class="hy-input-text" type="password" id="preshared_key" name="psk" placeholder="Pre-shared key"
        required />
    </div>
    <div class="hy-tmpl-preshared-key-row">
      <button class="hy-button hy-button-primary hy-button-fill" type="submit">Done</button>
    </div>
    <div class="hy-tmpl-preshared-key-row">
      <button class="hy-button hy-button-text-only" type="button"
        onclick="sonyBraviaAndroidTvPresharedKey.onClickInstructions()">Setting up a pre-shared key</button>
    </div>
  </form>
</main>

<script type="text/javascript">
  class SonyBraviaAndroidTvPresharedKey {
    constructor() {
      if (this.device) {
        Homey.setTitle(`Setup PSK for ${this.device.name}`);
      }

      Homey.getViewStoreValue('add_devices', 'devices', (err, device) => {
        this.device = device.shift();

        Homey.setTitle(`Setup PSK for ${this.device.name}`);
      })

      const form = document.querySelector('form');
      form.addEventListener('submit', e => this.onSubmit(e, this.device));
    }

    onSubmit(e, device) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const presharedKey = document.getElementById('preshared_key');

      device.settings.psk = formData.get('psk');

      Homey.showLoadingOverlay();
      Homey.emit('preshared_key', device, (err, device) => {
        if (err) {
          Homey.hideLoadingOverlay();
          return Homey.alert('Pre-shared key is invalid, check television settings.');
        }

        Homey.createDevice(device, () => {
          Homey.done();
        });
      });
    }

    onClickInstructions(e) {
      Homey.showView('instructions');
    }
  }

  const sonyBraviaAndroidTvPresharedKey = new SonyBraviaAndroidTvPresharedKey();
</script>

<style>
  .hy-tmpl-preshared-key {
    min-height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .hy-tmpl-preshared-key-image {
    display: block;
    position: relative;
    width: 25vw;
    height: 25vw;
    margin: 20vw auto;
    background-image: url('assets/images/locked-icon.svg');
    background-position: center center;
    background-repeat: no-repeat;
    background-size: contain;
  }

  .hy-tmpl-preshared-key-form {
    position: relative;
    width: 100%;
  }

  .hy-tmpl-preshared-key-row {
    margin-bottom: 1em;
  }

  .hy-button.hy-button-text-only {
    width: 100%;
    background: transparent;
  }

</style>
